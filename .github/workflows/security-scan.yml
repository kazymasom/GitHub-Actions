name: Ultimate Security Suite

on:
  pull_request:
    branches: [ "main", "master" ]
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: "0 3 * * *" # daily scan

permissions:
  contents: read
  security-events: write

jobs:

  codeql-analysis:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    outputs:
      high: ${{ steps.set-outputs.outputs.high }}
      medium: ${{ steps.set-outputs.outputs.medium }}
      low: ${{ steps.set-outputs.outputs.low }}
    steps:
      - uses: actions/checkout@v4

      - uses: github/codeql-action/init@v3
        with:
          languages: 'javascript, python, go, ruby, csharp, java'

      - run: echo "Add build commands if needed"

      - uses: github/codeql-action/analyze@v3

      - name: Set outputs
        id: set-outputs
        run: |
          high=$(jq '[.runs[0].results[] | select(.level=="error")] | length' codeql-results.sarif)
          medium=$(jq '[.runs[0].results[] | select(.level=="warning")] | length' codeql-results.sarif)
          low=$(jq '[.runs[0].results[] | select(.level=="note")] | length' codeql-results.sarif)
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "low=$low" >> $GITHUB_OUTPUT



  dependency-review:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    outputs:
      high: ${{ steps.set-outputs.outputs.high }}
      medium: ${{ steps.set-outputs.outputs.medium }}
      low: ${{ steps.set-outputs.outputs.low }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/dependency-review-action@v4
        id: dep-review
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set outputs
        id: set-outputs
        run: |
          high=$(jq '[.vulnerabilities[] | select(.severity=="HIGH")] | length' dep-review-output.json)
          medium=$(jq '[.vulnerabilities[] | select(.severity=="MODERATE" or .severity=="MEDIUM")] | length' dep-review-output.json)
          low=$(jq '[.vulnerabilities[] | select(.severity=="LOW" or .severity=="INFO")] | length' dep-review-output.json)
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "low=$low" >> $GITHUB_OUTPUT



  secret-scan:
    name: Secret Leak Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}



  container-scan:
    name: Container Vulnerability Scan
    runs-on: ubuntu-latest
    outputs:
      high: ${{ steps.set-outputs.outputs.high }}
      medium: ${{ steps.set-outputs.outputs.medium }}
      low: ${{ steps.set-outputs.outputs.low }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - run: docker build -t my-app:latest .

      - uses: aquasecurity/trivy-action@v2
        id: trivy
        with:
          image-ref: my-app:latest
          format: sarif
          output: trivy-report.sarif
          vuln-type: os,library

      - name: Set outputs
        id: set-outputs
        run: |
          high=$(jq '.runs[0].results | map(select(.level=="HIGH")) | length' trivy-report.sarif)
          medium=$(jq '.runs[0].results | map(select(.level=="MEDIUM")) | length' trivy-report.sarif)
          low=$(jq '.runs[0].results | map(select(.level=="LOW")) | length' trivy-report.sarif)
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "low=$low" >> $GITHUB_OUTPUT



  license-check:
    name: License Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install -g license-checker
      - run: license-checker --json > licenses.json
      - uses: actions/upload-artifact@v3
        with:
          name: licenses-report
          path: licenses.json



  pr-summary:
    name: PR Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-review, secret-scan, container-scan, license-check]
    steps:
      - uses: actions/checkout@v4

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ›¡ï¸ Ultimate Security Scan Summary"
          path: .github/pr-templates/pr-summary-template.md
